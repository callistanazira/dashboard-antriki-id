<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Dashboard Operator</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet" />
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
      <div class="d-flex align-items-center justify-content-between">
        <a href="dashboard-operator.html" class="logo d-flex align-items-center">
          <img src="assets/img/logo.png" alt="" />
          <span class="d-none d-lg-block">Antriki.id</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
      </div>
      <!-- End Logo -->
    </header>
    <!-- End Header -->

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link collapsed" href="dashboard-operator.html">
            <i class="bi bi-grid"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <!-- End Dashboard Nav -->

        <li class="nav-item">
          <div class="nav-link collapsed d-flex align-items-center">
            <i class="bi bi-check-square"></i>
            <span class="me-2">Status Loket</span>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggle-loket" onchange="toggleLoketStatus()" checked />
            </div>
          </div>
        </li>
        <!-- End Status Nav -->

        <li class="nav-item">
          <a class="nav-link collapsed" href="pages-logout.html?role=operator">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </a>
        </li>
        <!-- End Logout Nav -->
      </ul>
    </aside>

    <!-- End Sidebar-->

    <main id="main" class="main">
      <div class="pagetitle">
        <h1>Dashboard</h1>
        <nav>
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item active">Dashboard</li>
          </ol>
        </nav>
      </div>
      <!-- End Page Title -->

      <section class="section dashboard">
        <div class="row">
          <div class="col-md-4">
            <div class="card text-center shadow">
              <div class="card-body">
                <h5 class="card-title">Nomor Antrian Saat Ini</h5>
                <h1 class="display-3 fw-bold text-primary" id="current-number">A001</h1>
                <button class="btn btn-lg btn-success mt-3" onclick="nextQueue()">Panggil Berikutnya</button>
                <button class="btn btn-lg btn-warning mt-3" onclick="repeatQueue()">Panggil Ulang</button>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-4">
                <div class="card text-center shadow">
                  <div class="card-body">
                    <h5 class="card-title">Antrian Hari Ini</h5>
                    <h1 class="fw-bold" id="total-queue">0</h1>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-center shadow">
                  <div class="card-body">
                    <h5 class="card-title">Dilayani</h5>
                    <h1 class="fw-bold" id="serving-queue">0</h1>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card text-center shadow">
                  <div class="card-body">
                    <h5 class="card-title">Selesai</h5>
                    <h1 class="fw-bold" id="completed-queue">0</h1>
                  </div>
                </div>
              </div>
            </div>
            <div class="card shadow mt-3">
              <div class="card-body">
                <h5 class="card-title">Daftar Antrian</h5>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>Nomor Antrian</th>
                      <th>WhatsApp</th>
                      <th>Status</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="queue-list">
                    <tr>
                      <td>1</td>
                      <td>A002</td>
                      <td>+6281244584875</td>
                      <td>Menunggu</td>
                      <td><button class="btn btn-primary btn-sm" onclick="sendWarningMessage('6281244584875', 'A002')">Chat</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>Antriki.id</span></strong
        >. All Rights Reserved
      </div>
      <div class="credits">Designed by <a href="https://iqis.sch.id/">Qispro</a></div>
    </footer>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center btn btn-primary"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/chart.js/chart.umd.js"></script>
    <script src="assets/vendor/echarts/echarts.min.js"></script>
    <script src="assets/vendor/quill/quill.js"></script>
    <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <!-- audio panggil antrian -->
    <audio id="tingtung" src="assets/audio/tingtung.mp3"></audio>

    <!-- Kode JS untuk panggilan antrian -->
    <!-- Tambahkan SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      function nextQueue() {
        let queueList = document.querySelector("#queue-list");
        let firstRow = queueList.querySelector("tr");

        if (!firstRow) {
          Swal.fire({
            title: "Tidak Ada Antrian",
            text: "Semua antrian telah selesai.",
            icon: "info",
            confirmButtonColor: "#0d6efd",
          });
          return;
        }

        let newNumber = firstRow.children[1].innerText;

        Swal.fire({
          title: "Panggil Antrian?",
          text: `Apakah Anda yakin ingin memanggil nomor ${newNumber}?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Ya, Panggil",
          cancelButtonText: "Batal",
          confirmButtonColor: "#0d6efd",
        }).then((result) => {
          if (result.isConfirmed) {
            let phoneNumber = firstRow.children[2].innerText;
            document.getElementById("current-number").innerText = newNumber;
            queueList.removeChild(firstRow);

            // Panggil suara
            let bell = document.getElementById("tingtung");
            bell.play();
            setTimeout(() => {
              speakQueue(newNumber);
            }, 1500);
          }
        });
      }

      function repeatQueue() {
        let currentNumber = document.getElementById("current-number").innerText;

        Swal.fire({
          title: "Panggil Ulang?",
          text: `Nomor antrian ${currentNumber} akan dipanggil ulang.`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, Panggil",
          cancelButtonText: "Batal",
          confirmButtonColor: "#0d6efd",
        }).then((result) => {
          if (result.isConfirmed) {
            speakQueue(currentNumber);
          }
        });
      }

      function speakQueue(number) {
        let msgIntro = new SpeechSynthesisUtterance("Nomor antrian");
        msgIntro.lang = "id-ID";
        msgIntro.rate = 0.8;
        window.speechSynthesis.speak(msgIntro);

        let digits = number.split("");
        let delay = 1000;
        digits.forEach((digit) => {
          setTimeout(() => {
            let digitMsg = new SpeechSynthesisUtterance(digit);
            digitMsg.lang = "id-ID";
            digitMsg.rate = 0.7;
            window.speechSynthesis.speak(digitMsg);
          }, delay);
          delay += 1000;
        });

        setTimeout(() => {
          let msgEnd = new SpeechSynthesisUtterance("Silakan menuju loket.");
          msgEnd.lang = "id-ID";
          msgEnd.rate = 0.7;
          window.speechSynthesis.speak(msgEnd);
        }, delay + 500);
      }

      function sendWarningMessage(phone, number) {
        Swal.fire({
          title: "Kirim Pemberitahuan?",
          text: `Kirim pesan ke ${phone} untuk mengingatkan antrian ${number}?`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Ya, Kirim",
          cancelButtonText: "Batal",
          confirmButtonColor: "#0d6efd",
        }).then((result) => {
          if (result.isConfirmed) {
            let message = encodeURIComponent(`Halo, nomor antrian Anda ${number} sudah mendekati giliran. Silakan bersiap-siap.`);
            let url = `https://api.whatsapp.com/send?phone=${phone}&text=${message}`;
            window.open(url, "_blank");
          }
        });
      }

      function toggleLoketStatus() {
        let toggle = document.getElementById("toggle-loket");
        let isActive = toggle.checked;

        Swal.fire({
          title: isActive ? "Loket Aktif" : "Loket Nonaktif",
          text: isActive ? "Loket sekarang dalam keadaan aktif." : "Loket sekarang dalam keadaan nonaktif.",
          icon: isActive ? "success" : "warning",
          confirmButtonColor: "#0d6efd",
        });

        // Simpan status di localStorage
        localStorage.setItem("loketStatus", isActive ? "aktif" : "nonaktif");

        // Nonaktifkan semua tombol di dashboard kecuali tombol dalam alert
        setButtonState(isActive);
      }

      // Fungsi untuk mengaktifkan / menonaktifkan tombol di dashboard
      function setButtonState(isEnabled) {
        let buttons = document.querySelectorAll("button:not(.swal2-confirm):not(.swal2-cancel)"); // Hindari tombol di SweetAlert
        buttons.forEach((button) => {
          button.disabled = !isEnabled;
        });
      }

      // Set status awal dari localStorage saat halaman dimuat
      document.addEventListener("DOMContentLoaded", function () {
        let toggle = document.getElementById("toggle-loket");
        let isActive = localStorage.getItem("loketStatus") === "aktif";

        toggle.checked = isActive;
        setButtonState(isActive); // Pastikan tombol sesuai dengan status loket
      });
    </script>
  </body>
</html>
